const airlinesPro = () => {
  const flights = [
    { id: 00, to: "New York", from: "Barcelona", cost: 700, layover: false },
    { id: 01, to: "Los Angeles", from: "Madrid", cost: 1100, layover: true },
    { id: 02, to: "Paris", from: "Barcelona", cost: 210, layover: false },
    { id: 03, to: "Roma", from: "Barcelona", cost: 150, layover: false },
    { id: 04, to: "London", from: "Madrid", cost: 200, layover: false },
    { id: 05, to: "Madrid", from: "Barcelona", cost: 90, layover: false },
    { id: 06, to: "Tokyo", from: "Madrid", cost: 1500, layover: true },
    { id: 07, to: "Shangai", from: "Barcelona", cost: 800, layover: true },
    { id: 08, to: "Sydney", from: "Barcelona", cost: 150, layover: true },
    { id: 09, to: "Tel-Aviv", from: "Madrid", cost: 150, layover: false },
  ];

  let name;
  const goodbyeMessage = (input) => {
    if (input === null || input === undefined || !input) {
      console.log(
        "Thank you for visiting ISDI Coders Airlines, see you later!"
      );

      return;
    }
  };
  const anotherOperation = () => {
    let anotherMessage = confirm(
      "Do you want to perform or cancel the operation? accept / cancel"
    );

    if (anotherMessage) {
      administratorOrUser();
      return;
    } else {
      anotherMessage = false;
      goodbyeMessage(anotherMessage);
    }
    return;
  };
  const inputData = () => {
    name = prompt(`Welcome indicate your name please.`);
    if (name === null) {
      return;
    }

    const welcomeMessage =
      name === " "
        ? console.log(`Welcome to ISDI Coders Airlines!`)
        : console.log(`Welcome to ISDI Coders Airlines ${name}!`);
    return name;
  };
  inputData();

  const airlines = () => {
    console.log(`This is the information of all the flights:\n`);
    const flightSchedule = (flights) => {
      const flightsDescription = flights
        .map(
          (flight) =>
            `The flight ${flight.id} with origin ${flight.from} and destiny ${
              flight.to
            } has a cost of ${flight.cost}€ and ${
              flight.layover
                ? "makes a stopover."
                : "does not make any stopovers."
            }`
        )
        .join("\n");

      console.log(`${flightsDescription}`);
      return;
    };
    flightSchedule(flights);

    const averageCost = (flights) => {
      let totalCost = flights.reduce(
        (accumulator, flight) => accumulator + flight.cost,
        0
      );
      let averageCost = totalCost / flights.length;

      console.log(`The average cost of flights is: ${averageCost}€`);
      return;
    };
    averageCost(flights);

    console.log(`These are the flights with stopovers:\n`);
    const flightsWithStopovers = (flights) => {
      const groupeFlight = flights
        .filter((flight) => flight.layover === true)
        .sort((a, b) => a.cost - b.cost)
        .map(
          (flight) =>
            `The flight ${flight.id} with origin ${flight.from} and destiny ${flight.to} has a cost of ${flight.cost}€.`
        )
        .join("\n");
      console.log(`${groupeFlight}`);
      return;
    };
    flightsWithStopovers(flights);

    const lastFlights = (flights) => {
      const last5Destinations = flights
        .slice(-5)
        .map((flight) => flight.to)
        .join("\n");

      console.log(
        `These are the last 5 flights today, bound for:\n${last5Destinations}.`
      );

      return;
    };

    lastFlights(flights);
  };

  if (name === null) {
    console.log("Thank you for visiting ISDI Coders Airlines!, see you later!");
    return;
  } else {
    airlines();
  }

  const updated = () => {
    let updatedFlights = flights
      .map(
        (flight) =>
          `The flight ${flight.id} with origin ${flight.from} and destination ${
            flight.to
          } has a cost of ${flight.cost}€ and ${
            flight.layover
              ? "makes a stopover."
              : "does not make any stopovers."
          }`
      )
      .join("\n");

    return updatedFlights;
  };

  const adminAddFlights = () => {
    let letters = /^[A-Za-z]+$/;
    if (flights.length > 15) {
      alert("Cannot add more flights. Maximum limit reached.");

      getVerification();
      return;
    }

    let getDestination = prompt("Please enter the destination of the flight:");

    if (getDestination === null) {
      goodbyeMessage(getDestination);
      return;
    } else if (!letters.test(getDestination)) {
      invalidInput();
      getDestination = prompt("Please enter the destination of the flight:");
    }
    let getOrigin = prompt("Please enter the origin of the flight:");
    if (getOrigin === null) {
      goodbyeMessage(getOrigin);
      return;
    } else if (!letters.test(getOrigin)) {
      invalidInput();
      getOrigin = prompt("Please enter the origin of the flight:");
    }

    let getCost = +prompt("Please enter the cost of the flight:");
    if (cost === null) {
      goodbyeMessage(getCost);
      return;
    } else if (Number.isNaN(Number(getCost))) {
      invalidInput();
      getCost = +prompt("Please enter the cost of the flight:");
    }

    let getLayover = prompt(`Is this a layover flight? 'TRUE' / 'FALSE'`);
    if (getLayover === null) {
      goodbyeMessage(getLayover);
      return;
    }

    if (getLayover !== "TRUE" && getLayover !== "FALSE") {
      invalidInput();
      getLayover = prompt("Is this a layover flight?  'TRUE' / 'FALSE'");
    }
    getLayover = getLayover === "TRUE" ? true : false;

    let currentNumberOfFlights = flights.length;
    for (let i = 0; i < 1; i++) {
      let newFlight = {
        id: currentNumberOfFlights + i,
        to: getDestination,
        from: getOrigin,
        cost: getCost,
        layover: getLayover ? true : false,
      };

      flights.push(newFlight);
      console.log(`The flight ${newFlight.id} has been added successfully.`);
      console.log(updated());

      anotherOperation();
      return;
    }
  };

  const removeFlights = (id) => {
    let questionDelete = +prompt(
      `Please enter the id of the flight you want to delete:`
    );
    if (questionDelete === null) {
      return goodbyeMessage(questionDelete);
    }
    if (Number.isNaN(parseInt(questionDelete))) {
      invalidInput();
      removeFlights();
    }
    const index = flights.findIndex(
      (flight) => flight.id === Number(questionDelete)
    );
    if (index === -1) {
      alert(`The flight with id ${questionDelete} could not be found.`);
      removeFlights();
      return;
    }
    let confirmationDeleteFlights = prompt(
      `Are you sure you want to delete the flight with id ${questionDelete}? Y/N.`
    );
    if (confirmationDeleteFlights === null) {
      return goodbyeMessage(confirmationDeleteFlights);
    }
    confirmationDeleteFlights = confirmationDeleteFlights.toUpperCase();

    if (
      confirmationDeleteFlights !== "Y" &&
      confirmationDeleteFlights !== "N"
    ) {
      invalidInput();
    }
    if (confirmationDeleteFlights === "Y") {
      flights.splice(index, 1);
      console.log(`The flight with id ${questionDelete} has been deleted.`);
      console.log(updated());
      anotherOperation();
    } else if (confirmationDeleteFlights === "N") {
      anotherOperation();
    }
    return;
  };
  const userSearchPrice = () => {
    const minimumPrice = flights.reduce((min, flight) => {
      return Math.min(min, flight.cost);
    }, Infinity);
    const maximumPrice = flights.reduce((max, flight) => {
      return Math.max(max, flight.cost);
    }, -Infinity);
    alert(
      `The minimum prices are: ${minimumPrice}€ and the maximum prices are: ${maximumPrice}€`
    );
    let lookUpPrice = prompt("Please enter the price you want to search:");
    if (lookUpPrice === null) {
      goodbyeMessage(lookUpPrice);
      return;
    }
    if (Number.isNaN(Number(lookUpPrice))) {
      invalidInput();
      userSearchPrice();
    }
    if (lookUpPrice < minimumPrice || lookUpPrice > maximumPrice) {
      alert("You have entered a non-existent price, please try again.");
      userSearchPrice();
    }
    const examineFlights = (flights) => {
      const priceFinder = flights
        .filter((flight) => flight.cost <= lookUpPrice)
        .sort((a, b) => b.cost - a.cost)
        .map((flight) => {
          return `The flight ${flight.id} with origin ${
            flight.from
          } and destination ${flight.to} has a cost of ${flight.cost}€ ${
            flight.layover
              ? "makes a stopover."
              : "does not make any stopovers."
          }`;
        });
      console.log(priceFinder.join("\n"));

      anotherOperation();
    };
    return examineFlights(flights);
  };

  const getVerification = () => {
    let action = prompt(
      `What action do you want to perform? press ADD, DELETE, SHOW. If you want to go back to the beginning press BACK`
    );

    if (action === null) {
      goodbyeMessage(action);
      return;
    }

    action = action.toUpperCase();

    if (action === "ADD") {
      adminAddFlights();
    } else if (action === "SHOW") {
      console.log(updated());

      return getVerification();
    } else if (action === "DELETE") {
      removeFlights();
      return getVerification();
    } else if (action === "BACK") {
      administratorOrUser();
    }

    return action;
  };

  const administratorOrUser = () => {
    const question = prompt(
      `Can you tell me if you are a user or an administrator please? ADMIN/USER`
    );
    if (question === null) {
      goodbyeMessage(question);
      return;
    }

    const answer = question.toUpperCase();

    if (answer === "ADMIN") {
      alert("Welcome Admin!");
      getVerification();
    } else if (answer === "USER") {
      alert("Welcome User!");
      userSearchPrice();
    } else {
      invalidInput();
      administratorOrUser();
    }

    goodbyeMessage(answer);
  };
  administratorOrUser();
};
airlinesPro();
